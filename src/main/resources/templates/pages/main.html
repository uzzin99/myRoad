<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:replace="fragments/header.html :: fragment-header"></th:block>
</head>
<style>
  #eventModal {
    display: none;
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    padding: 20px;
    border: 1px solid #ccc;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    z-index: 1000;
  }

  #eventModal input, #eventModal textarea {
    width: 100%;
    margin-bottom: 10px;
  }
</style>
<body class="g-sidenav-show bg-gray-100">
  <div class="min-height-300 bg-dark position-absolute w-100"></div>

  <!--aside-->
  <th:block th:replace="fragments/aside.html :: fragment-aside"></th:block>
  <!--End aside-->

  <main class="main-content position-relative border-radius-lg">

    <!-- Navbar -->
    <th:block th:replace="fragments/nav.html :: fragment-nav"></th:block>
    <!-- End Navbar -->

    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-12">
          <div class="card mb-4">
            <div class="card-header pb-0">
              <h6>캘린더</h6>
            </div>
            <div class="card-body pb-4">
              <div id='calendar'></div>

              <!-- 모달 폼 -->
              <div id="eventModal">
                <h3>일정 추가</h3>
                <input type="text" id="eventTitle" placeholder="제목 입력" />
                <textarea id="eventDesc" rows="3" placeholder="내용 입력"></textarea>
                <input type="date" id="eventStart" />
                <input type="date" id="eventEnd" />
                <button id="saveEventBtn">저장</button>
                <button id="cancelEventBtn">취소</button>
              </div>
              <!-- 모달 폼 -->
            </div>
          </div>
        </div>
      </div>
      <!--footer-->
      <th:block th:replace="fragments/footer.html :: fragment-footer"></th:block>
      <!--End footer-->
    </div>
  </main>
  <th:block th:replace="fragments/footer.html :: fragment-plugin"></th:block>

  <th:block th:replace="fragments/scripts.html :: fragment-footer-scripts"></th:block>
</body>
<script>
  let calendar;
  let selectedInfo = null;

  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      selectable: true,
      contentHeight: 600,
      locale: "ko",
      select: function (info) {
        selectedInfo = info;

        // 날짜 기본값 설정
        document.getElementById('eventStart').value = info.startStr;
        document.getElementById('eventEnd').value = info.startStr;

        // 모달 열기
        document.getElementById('eventModal').style.display = 'block';
      },
      eventClick: function (info) {
        const event = info.event;
        alert(
          '제목: ' + event.title + '\n' +
          '내용: ' + (event.extendedProps.description || '(없음)') + '\n' +
          '시작일: ' + event.start.toISOString().slice(0, 10) + '\n' +
          '종료일: ' + (event.end ? event.end.toISOString().slice(0, 10) : '(없음)')
        );
      }
    });

    calendar.render();
  });

  // 저장 버튼
  document.getElementById('saveEventBtn').addEventListener('click', function () {
    const title = document.getElementById('eventTitle').value;
    const desc = document.getElementById('eventDesc').value;
    const start = document.getElementById('eventStart').value;
    const end = document.getElementById('eventEnd').value;

    const eventData = {
      title: title,
      description: desc,
      startDate: start,
      endDate: end
    };

    // Axios POST 요청
    axios.post('/api/schedule/create', eventData)
      .then(response => {
      // 요청 성공 시, 받은 이벤트 데이터로 캘린더에 추가
      const savedEvent = response.data;
      console.log("22222"+savedEvent);
      calendar.addEvent({
<!--        id: savedEvent.id, // 서버에서 생성한 ID가 있다고 가정-->
        title: savedEvent.title,
        start: savedEvent.startDate,
        end: savedEvent.endDate,
        allDay: true,
        extendedProps: {
          description: savedEvent.description
        }
      });

      // 입력 초기화 및 모달 닫기
      document.getElementById('eventTitle').value = '';
      document.getElementById('eventDesc').value = '';
      document.getElementById('eventStart').value = '';
      document.getElementById('eventEnd').value = '';
      document.getElementById('eventModal').style.display = 'none';
    })
    .catch(error => {
      console.error('이벤트 저장 중 오류 발생:', error);
      alert('이벤트 저장에 실패했습니다. 다시 시도해주세요.');
    });
  });

  // 취소 버튼
  document.getElementById('cancelEventBtn').addEventListener('click', function () {
    document.getElementById('eventModal').style.display = 'none';
  });
</script>
</html>